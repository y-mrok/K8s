# Setup - kubeadm
## Reference

Oracle VirtualBox:  https://www.virtualbox.org/

Vagrant: https://www.vagrantup.com/

Link to download VM images: http://osboxes.org/

Link to kubeadm installation instructions: https://kubernetes.io/docs/setup/independent/install-kubeadm/

The link to Vagrant file:  
https://github.com/kodekloudhub/certified-kubernetes-administrator-course

If you are new to VirtualBox or Vagrant, please follow this pre-requisites course to learn about it:  
https://www.youtube.com/watch?v=Wvf0mBNGjXY

## Kubernetes Setup - Kubeadm
- マルチノードクラスターを作成するのに使用する
- クラスターを作成する手順  
  1. クラスターを構成するために複数のシステムまたは仮想マシンをプロビジョニング
  2. 1 つをマスターノードに指定、それ以外をワーカーノードに指定
  3. 各ノードにコンテナランタイム（ Docker ）をインストール
  4. 各ノードに kubeadm ツールをインストール
  5. マスターノードをイニシャライズ　=　マスターノードに必要なコンポーネとをインストール
  6. ネットワークの前提条件を満たしていることを確認  
      - 各ノードにまたがる POD ネットワークを設定
  7. マスターノードにワーカーノードを結合

## Demo - Setup Lab - VirtualBox
### 事前準備
- VirutalBox + Vagrant で環境を構築する
  - Orcle VirtualBox
    - https://www.virtualbox.org/wiki/Linux_Downloads
    - Ubuntu 22.04 用パッケージをダウンロードしインストール
  - Vagrant
    - https://www.virtualbox.org/wiki/Linux_Downloads
    - Ubuntu/Debian 用インストールコマンド
    ```bash
    wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
    sudo apt update && sudo apt install vagrant
    ```
### 手順  
1. GitHub から Vagrant ファイルをクローン
```bash
git clone https://github.com/kodekloudhub/certified-kubernetes-administrator-course.git
```
```
_mrok@pc:~/k8s$ y_mrok@pc:~/k8s$ git clone https://github.com/kodekloudhub/certified-kubernetes-administrator-course.git
Cloning into 'certified-kubernetes-administrator-course'...
remote: Enumerating objects: 4031, done.
remote: Counting objects: 100% (409/409), done.
remote: Compressing objects: 100% (323/323), done.
remote: Total 4031 (delta 156), reused 286 (delta 86), pack-reused 3622
Receiving objects: 100% (4031/4031), 65.32 MiB | 9.15 MiB/s, done.
Resolving deltas: 100% (1962/1962), done.
y_mrok@pc:~/k8s$
```
2. `vagrant up` コマンドを実行し、ノードを作成
```bash
ls
cd certified-kubernetes-administrator-course/
cat Vagrantfile
vagrant status
vagrant up
vagrant status
vagrant ssh kubemaster
uptime
logout
vagrant ssh kubenode01
logout
vagrant ssh kubenode02
logout
```
```
y_mrok@pc:~/k8s/certified-kubernetes-administrator-course$ cat Vagrantfile
# -*- mode: ruby -*-
# vi:set ft=ruby sw=2 ts=2 sts=2:

# Define the number of master and worker nodes
# If this number is changed, remember to update setup-hosts.sh script with the new hosts IP details in /etc/hosts of each VM.
NUM_MASTER_NODE = 1
NUM_WORKER_NODE = 2

IP_NW = "192.168.56."
MASTER_IP_START = 1
NODE_IP_START = 2

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.
Vagrant.configure("2") do |config|
  # The most common configuration options are documented and commented below.
  # For a complete reference, please see the online documentation at
  # https://docs.vagrantup.com.

  # Every Vagrant development environment requires a box. You can search for
  # boxes at https://vagrantcloud.com/search.
  # config.vm.box = "base"
  config.vm.box = "ubuntu/bionic64"

  # Disable automatic box update checking. If you disable this, then
  # boxes will only be checked for updates when the user runs
  # `vagrant box outdated`. This is not recommended.
  config.vm.box_check_update = false

  # Create a public network, which generally matched to bridged network.
  # Bridged networks make the machine appear as another physical device on
  # your network.
  # config.vm.network "public_network"

  # Share an additional folder to the guest VM. The first argument is
  # the path on the host to the actual folder. The second argument is
  # the path on the guest to mount the folder. And the optional third
  # argument is a set of non-required options.
  # config.vm.synced_folder "../data", "/vagrant_data"

  # Provider-specific configuration so you can fine-tune various
  # backing providers for Vagrant. These expose provider-specific options.
  # Example for VirtualBox:
  #
  # config.vm.provider "virtualbox" do |vb|
  #   # Customize the amount of memory on the VM:
  #   vb.memory = "1024"
  # end
  #
  # View the documentation for the provider you are using for more
  # information on available options.

  # Provision Master Nodes
  (1..NUM_MASTER_NODE).each do |i|
      config.vm.define "kubemaster" do |node|
        # Name shown in the GUI
        node.vm.provider "virtualbox" do |vb|
            vb.name = "kubemaster"
            vb.memory = 2048
            vb.cpus = 2
        end
        node.vm.hostname = "kubemaster"
        node.vm.network :private_network, ip: IP_NW + "#{MASTER_IP_START + i}"
        node.vm.network "forwarded_port", guest: 22, host: "#{2710 + i}"

        node.vm.provision "setup-hosts", :type => "shell", :path => "ubuntu/vagrant/setup-hosts.sh" do |s|
          s.args = ["enp0s8"]
        end

        node.vm.provision "setup-dns", type: "shell", :path => "ubuntu/update-dns.sh"

      end
  end


  # Provision Worker Nodes
  (1..NUM_WORKER_NODE).each do |i|
    config.vm.define "kubenode0#{i}" do |node|
        node.vm.provider "virtualbox" do |vb|
            vb.name = "kubenode0#{i}"
            vb.memory = 2048
            vb.cpus = 2
        end
        node.vm.hostname = "kubenode0#{i}"
        node.vm.network :private_network, ip: IP_NW + "#{NODE_IP_START + i}"
                node.vm.network "forwarded_port", guest: 22, host: "#{2720 + i}"

        node.vm.provision "setup-hosts", :type => "shell", :path => "ubuntu/vagrant/setup-hosts.sh" do |s|
          s.args = ["enp0s8"]
        end

        node.vm.provision "setup-dns", type: "shell", :path => "ubuntu/update-dns.sh"
    end
  end
end
y_mrok@pc:~/k8s/certified-kubernetes-administrator-course$ vagrant status
Current machine states:

kubemaster                not created (virtualbox)
kubenode01                not created (virtualbox)
kubenode02                not created (virtualbox)

This environment represents multiple VMs. The VMs are all listed
above with their current state. For more information about a specific
VM, run `vagrant status NAME`.
y_mrok@pc:~/k8s/certified-kubernetes-administrator-course$ vagrant up
Bringing machine 'kubemaster' up with 'virtualbox' provider...
Bringing machine 'kubenode01' up with 'virtualbox' provider...
Bringing machine 'kubenode02' up with 'virtualbox' provider...
==> kubemaster: Importing base box 'ubuntu/bionic64'...
==> kubemaster: Matching MAC address for NAT networking...
==> kubemaster: Setting the name of the VM: kubemaster
==> kubemaster: Clearing any previously set network interfaces...
==> kubemaster: Preparing network interfaces based on configuration...
    kubemaster: Adapter 1: nat
    kubemaster: Adapter 2: hostonly
==> kubemaster: Forwarding ports...
    kubemaster: 22 (guest) => 2711 (host) (adapter 1)
    kubemaster: 22 (guest) => 2222 (host) (adapter 1)
==> kubemaster: Running 'pre-boot' VM customizations...
==> kubemaster: Booting VM...
==> kubemaster: Waiting for machine to boot. This may take a few minutes...
    kubemaster: SSH address: 127.0.0.1:2222
    kubemaster: SSH username: vagrant
    kubemaster: SSH auth method: private key
    kubemaster: 
    kubemaster: Vagrant insecure key detected. Vagrant will automatically replace
    kubemaster: this with a newly generated keypair for better security.
    kubemaster: 
    kubemaster: Inserting generated public key within guest...
    kubemaster: Removing insecure key from the guest if it's present...
    kubemaster: Key inserted! Disconnecting and reconnecting using new SSH key...
==> kubemaster: Machine booted and ready!
==> kubemaster: Checking for guest additions in VM...
    kubemaster: The guest additions on this VM do not match the installed version of
    kubemaster: VirtualBox! In most cases this is fine, but in rare cases it can
    kubemaster: prevent things such as shared folders from working properly. If you see
    kubemaster: shared folder errors, please make sure the guest additions within the
    kubemaster: virtual machine match the version of VirtualBox you have installed on
    kubemaster: your host and reload your VM.
    kubemaster: 
    kubemaster: Guest Additions Version: 5.2.42
    kubemaster: VirtualBox Version: 6.1
==> kubemaster: Setting hostname...
==> kubemaster: Configuring and enabling network interfaces...
==> kubemaster: Mounting shared folders...
    kubemaster: /vagrant => /home/y_mrok/k8s/certified-kubernetes-administrator-course
==> kubemaster: Running provisioner: setup-hosts (shell)...
    kubemaster: Running: /tmp/vagrant-shell20220820-2932-1rj4nb9.sh
==> kubemaster: Running provisioner: setup-dns (shell)...
    kubemaster: Running: /tmp/vagrant-shell20220820-2932-1sqlmr0.sh
==> kubenode01: Importing base box 'ubuntu/bionic64'...
==> kubenode01: Matching MAC address for NAT networking...
==> kubenode01: Setting the name of the VM: kubenode01
==> kubenode01: Fixed port collision for 22 => 2222. Now on port 2200.
==> kubenode01: Clearing any previously set network interfaces...
==> kubenode01: Preparing network interfaces based on configuration...
    kubenode01: Adapter 1: nat
    kubenode01: Adapter 2: hostonly
==> kubenode01: Forwarding ports...
    kubenode01: 22 (guest) => 2721 (host) (adapter 1)
    kubenode01: 22 (guest) => 2200 (host) (adapter 1)
==> kubenode01: Running 'pre-boot' VM customizations...
==> kubenode01: Booting VM...
==> kubenode01: Waiting for machine to boot. This may take a few minutes...
    kubenode01: SSH address: 127.0.0.1:2200
    kubenode01: SSH username: vagrant
    kubenode01: SSH auth method: private key
    kubenode01: Warning: Connection reset. Retrying...
    kubenode01: 
    kubenode01: Vagrant insecure key detected. Vagrant will automatically replace
    kubenode01: this with a newly generated keypair for better security.
    kubenode01: 
    kubenode01: Inserting generated public key within guest...
    kubenode01: Removing insecure key from the guest if it's present...
    kubenode01: Key inserted! Disconnecting and reconnecting using new SSH key...
==> kubenode01: Machine booted and ready!
==> kubenode01: Checking for guest additions in VM...
    kubenode01: The guest additions on this VM do not match the installed version of
    kubenode01: VirtualBox! In most cases this is fine, but in rare cases it can
    kubenode01: prevent things such as shared folders from working properly. If you see
    kubenode01: shared folder errors, please make sure the guest additions within the
    kubenode01: virtual machine match the version of VirtualBox you have installed on
    kubenode01: your host and reload your VM.
    kubenode01: 
    kubenode01: Guest Additions Version: 5.2.42
    kubenode01: VirtualBox Version: 6.1
==> kubenode01: Setting hostname...
==> kubenode01: Configuring and enabling network interfaces...
==> kubenode01: Mounting shared folders...
    kubenode01: /vagrant => /home/y_mrok/k8s/certified-kubernetes-administrator-course
==> kubenode01: Running provisioner: setup-hosts (shell)...
    kubenode01: Running: /tmp/vagrant-shell20220820-2932-fwm4zg.sh
==> kubenode01: Running provisioner: setup-dns (shell)...
    kubenode01: Running: /tmp/vagrant-shell20220820-2932-kew7gz.sh
==> kubenode02: Importing base box 'ubuntu/bionic64'...
==> kubenode02: Matching MAC address for NAT networking...
==> kubenode02: Setting the name of the VM: kubenode02
==> kubenode02: Fixed port collision for 22 => 2222. Now on port 2201.
==> kubenode02: Clearing any previously set network interfaces...
==> kubenode02: Preparing network interfaces based on configuration...
    kubenode02: Adapter 1: nat
    kubenode02: Adapter 2: hostonly
==> kubenode02: Forwarding ports...
    kubenode02: 22 (guest) => 2722 (host) (adapter 1)
    kubenode02: 22 (guest) => 2201 (host) (adapter 1)
==> kubenode02: Running 'pre-boot' VM customizations...
==> kubenode02: Booting VM...
==> kubenode02: Waiting for machine to boot. This may take a few minutes...
    kubenode02: SSH address: 127.0.0.1:2201
    kubenode02: SSH username: vagrant
    kubenode02: SSH auth method: private key
    kubenode02: Warning: Connection reset. Retrying...
    kubenode02: 
    kubenode02: Vagrant insecure key detected. Vagrant will automatically replace
    kubenode02: this with a newly generated keypair for better security.
    kubenode02: 
    kubenode02: Inserting generated public key within guest...
    kubenode02: Removing insecure key from the guest if it's present...
    kubenode02: Key inserted! Disconnecting and reconnecting using new SSH key...
==> kubenode02: Machine booted and ready!
==> kubenode02: Checking for guest additions in VM...
    kubenode02: The guest additions on this VM do not match the installed version of
    kubenode02: VirtualBox! In most cases this is fine, but in rare cases it can
    kubenode02: prevent things such as shared folders from working properly. If you see
    kubenode02: shared folder errors, please make sure the guest additions within the
    kubenode02: virtual machine match the version of VirtualBox you have installed on
    kubenode02: your host and reload your VM.
    kubenode02: 
    kubenode02: Guest Additions Version: 5.2.42
    kubenode02: VirtualBox Version: 6.1
==> kubenode02: Setting hostname...
==> kubenode02: Configuring and enabling network interfaces...
==> kubenode02: Mounting shared folders...
    kubenode02: /vagrant => /home/y_mrok/k8s/certified-kubernetes-administrator-course
==> kubenode02: Running provisioner: setup-hosts (shell)...
    kubenode02: Running: /tmp/vagrant-shell20220820-2932-1vxfm4l.sh
==> kubenode02: Running provisioner: setup-dns (shell)...
    kubenode02: Running: /tmp/vagrant-shell20220820-2932-xtt3a8.sh
y_mrok@pc:~/k8s/certified-kubernetes-administrator-course$ vagrant status
Current machine states:

kubemaster                running (virtualbox)
kubenode01                running (virtualbox)
kubenode02                running (virtualbox)

This environment represents multiple VMs. The VMs are all listed
above with their current state. For more information about a specific
VM, run `vagrant status NAME`.
y_mrok@pc:~/k8s/certified-kubernetes-administrator-course$ vagrant ssh kubemaster
Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 4.15.0-191-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sat Aug 20 09:25:29 UTC 2022

  System load:  0.02              Processes:             102
  Usage of /:   2.9% of 38.70GB   Users logged in:       0
  Memory usage: 6%                IP address for enp0s3: 10.0.2.15
  Swap usage:   0%                IP address for enp0s8: 192.168.56.2


0 updates can be applied immediately.

New release '20.04.4 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


vagrant@kubemaster:~$ uptime
 09:25:35 up 4 min,  1 user,  load average: 0.02, 0.12, 0.07
vagrant@kubemaster:~$ logout
y_mrok@pc:~/k8s/certified-kubernetes-administrator-course$ vagrant ssh kubenode01
Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 4.15.0-191-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sat Aug 20 09:25:51 UTC 2022

  System load:  0.04              Processes:             101
  Usage of /:   2.9% of 38.70GB   Users logged in:       0
  Memory usage: 6%                IP address for enp0s3: 10.0.2.15
  Swap usage:   0%                IP address for enp0s8: 192.168.56.3


0 updates can be applied immediately.

New release '20.04.4 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


vagrant@kubenode01:~$ logout
y_mrok@pc:~/k8s/certified-kubernetes-administrator-course$ vagrant ssh kubenode02
Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 4.15.0-191-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sat Aug 20 09:26:02 UTC 2022

  System load:  0.18              Processes:             103
  Usage of /:   2.9% of 38.70GB   Users logged in:       0
  Memory usage: 6%                IP address for enp0s3: 10.0.2.15
  Swap usage:   0%                IP address for enp0s8: 192.168.56.4


0 updates can be applied immediately.

New release '20.04.4 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


vagrant@kubenode02:~$ logout
y_mrok@pc:~/k8s/certified-kubernetes-administrator-course$ 
```

## Demo - Provision cluster using Kubeadm
- 参考 URL
  https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/install-kubeadm/
- 必須要件
  - メモリ　2GB
  - CPU　　2
  - ノード間のネットワーク接続
- ファイアウォールやネットワークセキュリティの設定を確認
※ 各処理は特に説明がない限り、すべてのノードで実行する

- `br_netfilter` モジュールがロードされていることを確認
```bash
sudo -i
lsmod | grep br_netfilter
sudo modprobe br_netfilter
lsmod | grep br_netfilter
```
```
vagrant@kubemaster:~$ sudo -i
root@kubemaster:~# lsmod | grep br_netfilter
root@kubemaster:~# sudo modprobe br_netfilter
root@kubemaster:~# lsmod | grep br_netfilter
br_netfilter           24576  0
bridge                155648  1 br_netfilter
root@kubemaster:~# 
```
```
vagrant@kubenode01:~$ sudo -i
root@kubenode01:~# lsmod | grep br_netfilter
root@kubenode01:~# sudo modprobe br_netfilter
root@kubenode01:~# lsmod | grep br_netfilter
br_netfilter           24576  0
bridge                155648  1 br_netfilter
root@kubenode01:~# 
```
```
vagrant@kubenode02:~$ sudo -i
root@kubenode02:~# lsmod | grep br_netfilter
root@kubenode02:~# sudo modprobe br_netfilter
root@kubenode02:~# lsmod | grep br_netfilter
br_netfilter           24576  0
bridge                155648  1 br_netfilter
root@kubenode02:~# 
```
- iptables がブリッジを通過するトラフィックを処理できるようにする
```bash
cat <<EOF | > sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sudo sysctl --system
```
```
root@kubemaster:~# cat <<EOF | > sudo tee /etc/sysctl.d/k8s.conf
> net.bridge.bridge-nf-call-ip6tables = 1
> net.bridge.bridge-nf-call-iptables = 1
> EOF
root@kubemaster:~# sudo sysctl --system
* Applying /etc/sysctl.d/10-console-messages.conf ...
kernel.printk = 4 4 1 7
* Applying /etc/sysctl.d/10-ipv6-privacy.conf ...
net.ipv6.conf.all.use_tempaddr = 2
net.ipv6.conf.default.use_tempaddr = 2
* Applying /etc/sysctl.d/10-kernel-hardening.conf ...
kernel.kptr_restrict = 1
* Applying /etc/sysctl.d/10-link-restrictions.conf ...
fs.protected_hardlinks = 1
fs.protected_symlinks = 1
* Applying /etc/sysctl.d/10-lxd-inotify.conf ...
fs.inotify.max_user_instances = 1024
* Applying /etc/sysctl.d/10-magic-sysrq.conf ...
kernel.sysrq = 176
* Applying /etc/sysctl.d/10-network-security.conf ...
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.tcp_syncookies = 1
* Applying /etc/sysctl.d/10-ptrace.conf ...
kernel.yama.ptrace_scope = 1
* Applying /etc/sysctl.d/10-zeropage.conf ...
vm.mmap_min_addr = 65536
* Applying /usr/lib/sysctl.d/50-default.conf ...
net.ipv4.conf.all.promote_secondaries = 1
net.core.default_qdisc = fq_codel
* Applying /etc/sysctl.d/99-cloudimg-ipv6.conf ...
net.ipv6.conf.all.use_tempaddr = 0
net.ipv6.conf.default.use_tempaddr = 0
* Applying /etc/sysctl.d/99-sysctl.conf ...
* Applying /etc/sysctl.d/k8s.conf ...
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
* Applying /etc/sysctl.conf ...
root@kubemaster:~# 
```
```
root@kubenode01:~# cat <<EOF | > sudo tee /etc/sysctl.d/k8s.conf
> net.bridge.bridge-nf-call-ip6tables = 1
> net.bridge.bridge-nf-call-iptables = 1
> EOF
root@kubenode01:~# sudo sysctl --system
* Applying /etc/sysctl.d/10-console-messages.conf ...
kernel.printk = 4 4 1 7
* Applying /etc/sysctl.d/10-ipv6-privacy.conf ...
net.ipv6.conf.all.use_tempaddr = 2
net.ipv6.conf.default.use_tempaddr = 2
* Applying /etc/sysctl.d/10-kernel-hardening.conf ...
kernel.kptr_restrict = 1
* Applying /etc/sysctl.d/10-link-restrictions.conf ...
fs.protected_hardlinks = 1
fs.protected_symlinks = 1
* Applying /etc/sysctl.d/10-lxd-inotify.conf ...
fs.inotify.max_user_instances = 1024
* Applying /etc/sysctl.d/10-magic-sysrq.conf ...
kernel.sysrq = 176
* Applying /etc/sysctl.d/10-network-security.conf ...
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.tcp_syncookies = 1
* Applying /etc/sysctl.d/10-ptrace.conf ...
kernel.yama.ptrace_scope = 1
* Applying /etc/sysctl.d/10-zeropage.conf ...
vm.mmap_min_addr = 65536
* Applying /usr/lib/sysctl.d/50-default.conf ...
net.ipv4.conf.all.promote_secondaries = 1
net.core.default_qdisc = fq_codel
* Applying /etc/sysctl.d/99-cloudimg-ipv6.conf ...
net.ipv6.conf.all.use_tempaddr = 0
net.ipv6.conf.default.use_tempaddr = 0
* Applying /etc/sysctl.d/99-sysctl.conf ...
* Applying /etc/sysctl.d/k8s.conf ...
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
* Applying /etc/sysctl.conf ...
root@kubenode01:~# 
```
```
root@kubenode02:~# cat <<EOF | > sudo tee /etc/sysctl.d/k8s.conf
> net.bridge.bridge-nf-call-ip6tables = 1
> net.bridge.bridge-nf-call-iptables = 1
> EOF
root@kubenode02:~# sudo sysctl --system
* Applying /etc/sysctl.d/10-console-messages.conf ...
kernel.printk = 4 4 1 7
* Applying /etc/sysctl.d/10-ipv6-privacy.conf ...
net.ipv6.conf.all.use_tempaddr = 2
net.ipv6.conf.default.use_tempaddr = 2
* Applying /etc/sysctl.d/10-kernel-hardening.conf ...
kernel.kptr_restrict = 1
* Applying /etc/sysctl.d/10-link-restrictions.conf ...
fs.protected_hardlinks = 1
fs.protected_symlinks = 1
* Applying /etc/sysctl.d/10-lxd-inotify.conf ...
fs.inotify.max_user_instances = 1024
* Applying /etc/sysctl.d/10-magic-sysrq.conf ...
kernel.sysrq = 176
* Applying /etc/sysctl.d/10-network-security.conf ...
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.tcp_syncookies = 1
* Applying /etc/sysctl.d/10-ptrace.conf ...
kernel.yama.ptrace_scope = 1
* Applying /etc/sysctl.d/10-zeropage.conf ...
vm.mmap_min_addr = 65536
* Applying /usr/lib/sysctl.d/50-default.conf ...
net.ipv4.conf.all.promote_secondaries = 1
net.core.default_qdisc = fq_codel
* Applying /etc/sysctl.d/99-cloudimg-ipv6.conf ...
net.ipv6.conf.all.use_tempaddr = 0
net.ipv6.conf.default.use_tempaddr = 0
* Applying /etc/sysctl.d/99-sysctl.conf ...
* Applying /etc/sysctl.d/k8s.conf ...
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
* Applying /etc/sysctl.conf ...
root@kubenode02:~# 
```
- ランタイムをインストールする
```bash
# (Install Docker CE)
## リポジトリをセットアップ
### HTTPS越しのリポジトリの使用をaptに許可するために、パッケージをインストール
apt-get update && apt-get install -y \
  apt-transport-https ca-certificates curl software-properties-common gnupg2

# Docker公式のGPG鍵を追加:
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -

# Dockerのaptレポジトリを追加:
add-apt-repository \
  "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) \
  stable"

# Docker CEのインストール
apt-get update && apt-get install -y \
  containerd.io=1.2.13-2 \
  docker-ce=5:19.03.11~3-0~ubuntu-$(lsb_release -cs) \
  docker-ce-cli=5:19.03.11~3-0~ubuntu-$(lsb_release -cs)

# デーモンをセットアップ
cat > /etc/docker/daemon.json <<EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
   },
  "storage-driver": "overlay2"
}
EOF

mkdir -p /etc/systemd/system/docker.service.d

# dockerを再起動
systemctl daemon-reload
systemctl restart docker
systemctl status docker.service
```
```
root@kubemaster:~# apt-get update && apt-get install -y \
>   apt-transport-https ca-certificates curl software-properties-common gnupg2
Hit:1 http://archive.ubuntu.com/ubuntu bionic InRelease
Get:2 http://archive.ubuntu.com/ubuntu bionic-updates InRelease [88.7 kB]
Get:3 http://security.ubuntu.com/ubuntu bionic-security InRelease [88.7 kB]       
Get:4 http://archive.ubuntu.com/ubuntu bionic-backports InRelease [74.6 kB]                   
Get:5 http://archive.ubuntu.com/ubuntu bionic/universe amd64 Packages [8570 kB]                
Get:6 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages [2365 kB]
Get:7 http://security.ubuntu.com/ubuntu bionic-security/main Translation-en [410 kB]                                                                        
Get:8 http://security.ubuntu.com/ubuntu bionic-security/restricted amd64 Packages [859 kB]                                                                  
Get:9 http://security.ubuntu.com/ubuntu bionic-security/restricted Translation-en [118 kB]                                                                  
Get:10 http://security.ubuntu.com/ubuntu bionic-security/universe amd64 Packages [1222 kB]                                                                  
Get:11 http://security.ubuntu.com/ubuntu bionic-security/universe Translation-en [282 kB]                                                                   
Get:12 http://security.ubuntu.com/ubuntu bionic-security/multiverse amd64 Packages [19.0 kB]                                                                
Get:13 http://security.ubuntu.com/ubuntu bionic-security/multiverse Translation-en [3836 B]                                                                 
Get:14 http://archive.ubuntu.com/ubuntu bionic/universe Translation-en [4941 kB]                                                                            
Get:15 http://archive.ubuntu.com/ubuntu bionic/multiverse amd64 Packages [151 kB]                                                                           
Get:16 http://archive.ubuntu.com/ubuntu bionic/multiverse Translation-en [108 kB]                                                                           
Get:17 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages [2706 kB]                                                                        
Get:18 http://archive.ubuntu.com/ubuntu bionic-updates/main Translation-en [500 kB]                                                                         
Get:19 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 Packages [1837 kB]                                                                    
Get:20 http://archive.ubuntu.com/ubuntu bionic-updates/universe Translation-en [398 kB]                                                                     
Get:21 http://archive.ubuntu.com/ubuntu bionic-updates/multiverse amd64 Packages [24.9 kB]                                                                  
Get:22 http://archive.ubuntu.com/ubuntu bionic-updates/multiverse Translation-en [6012 B]                                                                   
Get:23 http://archive.ubuntu.com/ubuntu bionic-backports/main amd64 Packages [10.8 kB]                                                                      
Get:24 http://archive.ubuntu.com/ubuntu bionic-backports/main Translation-en [5016 B]                                                                       
Get:25 http://archive.ubuntu.com/ubuntu bionic-backports/universe amd64 Packages [11.6 kB]                                                                  
Get:26 http://archive.ubuntu.com/ubuntu bionic-backports/universe Translation-en [5864 B]                                                                   
Fetched 24.8 MB in 57s (432 kB/s)                                                                                                                           
Reading package lists... Done
Reading package lists... Done
Building dependency tree       
Reading state information... Done
ca-certificates is already the newest version (20211016~18.04.1).
ca-certificates set to manually installed.
curl is already the newest version (7.58.0-2ubuntu3.19).
curl set to manually installed.
software-properties-common is already the newest version (0.96.24.32.18).
software-properties-common set to manually installed.
The following NEW packages will be installed:
  apt-transport-https gnupg2
0 upgraded, 2 newly installed, 0 to remove and 2 not upgraded.
Need to get 9648 B of archives.
After this operation, 206 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 apt-transport-https all 1.6.14 [4348 B]
Get:2 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 gnupg2 all 2.2.4-1ubuntu1.6 [5300 B]
Fetched 9648 B in 1s (9978 B/s)  
Selecting previously unselected package apt-transport-https.
(Reading database ... 60132 files and directories currently installed.)
Preparing to unpack .../apt-transport-https_1.6.14_all.deb ...
Unpacking apt-transport-https (1.6.14) ...
Selecting previously unselected package gnupg2.
Preparing to unpack .../gnupg2_2.2.4-1ubuntu1.6_all.deb ...
Unpacking gnupg2 (2.2.4-1ubuntu1.6) ...
Setting up apt-transport-https (1.6.14) ...
Setting up gnupg2 (2.2.4-1ubuntu1.6) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
root@kubemaster:~# curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
OK
root@kubemaster:~# add-apt-repository \
>   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
>   $(lsb_release -cs) \
>   stable"
Get:1 https://download.docker.com/linux/ubuntu bionic InRelease [64.4 kB]
Hit:2 http://archive.ubuntu.com/ubuntu bionic InRelease                                                                                 
Get:3 https://download.docker.com/linux/ubuntu bionic/stable amd64 Packages [26.6 kB]         
Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease                                   
Hit:5 http://archive.ubuntu.com/ubuntu bionic-updates InRelease         
Hit:6 http://archive.ubuntu.com/ubuntu bionic-backports InRelease
Fetched 91.0 kB in 2s (54.5 kB/s)                  
Reading package lists... Done
root@kubemaster:~# apt-get update && apt-get install -y \
>   containerd.io=1.2.13-2 \
>   docker-ce=5:19.03.11~3-0~ubuntu-$(lsb_release -cs) \
>   docker-ce-cli=5:19.03.11~3-0~ubuntu-$(lsb_release -cs)
Hit:1 https://download.docker.com/linux/ubuntu bionic InRelease
Hit:2 http://security.ubuntu.com/ubuntu bionic-security InRelease                                                                   
Hit:3 http://archive.ubuntu.com/ubuntu bionic InRelease                                                                             
Hit:4 http://archive.ubuntu.com/ubuntu bionic-updates InRelease
Hit:5 http://archive.ubuntu.com/ubuntu bionic-backports InRelease
Reading package lists... Done                      
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  aufs-tools cgroupfs-mount libltdl7 pigz
The following NEW packages will be installed:
  aufs-tools cgroupfs-mount containerd.io docker-ce docker-ce-cli libltdl7 pigz
0 upgraded, 7 newly installed, 0 to remove and 2 not upgraded.
Need to get 85.3 MB of archives.
After this operation, 381 MB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu bionic/universe amd64 pigz amd64 2.4-1 [57.4 kB]
Get:2 https://download.docker.com/linux/ubuntu bionic/stable amd64 containerd.io amd64 1.2.13-2 [21.4 MB]
Get:3 http://archive.ubuntu.com/ubuntu bionic/universe amd64 aufs-tools amd64 1:4.9+20170918-1ubuntu1 [104 kB]
Get:4 http://archive.ubuntu.com/ubuntu bionic/universe amd64 cgroupfs-mount all 1.4 [6320 B]
Get:5 http://archive.ubuntu.com/ubuntu bionic/main amd64 libltdl7 amd64 2.4.6-2 [38.8 kB]
Get:6 https://download.docker.com/linux/ubuntu bionic/stable amd64 docker-ce-cli amd64 5:19.03.11~3-0~ubuntu-bionic [41.2 MB]
Get:7 https://download.docker.com/linux/ubuntu bionic/stable amd64 docker-ce amd64 5:19.03.11~3-0~ubuntu-bionic [22.5 MB]                                   
Fetched 85.3 MB in 18s (4757 kB/s)                                                                                                                          
Selecting previously unselected package pigz.
(Reading database ... 60143 files and directories currently installed.)
Preparing to unpack .../0-pigz_2.4-1_amd64.deb ...
Unpacking pigz (2.4-1) ...
Selecting previously unselected package aufs-tools.
Preparing to unpack .../1-aufs-tools_1%3a4.9+20170918-1ubuntu1_amd64.deb ...
Unpacking aufs-tools (1:4.9+20170918-1ubuntu1) ...
Selecting previously unselected package cgroupfs-mount.
Preparing to unpack .../2-cgroupfs-mount_1.4_all.deb ...
Unpacking cgroupfs-mount (1.4) ...
Selecting previously unselected package containerd.io.
Preparing to unpack .../3-containerd.io_1.2.13-2_amd64.deb ...
Unpacking containerd.io (1.2.13-2) ...
Selecting previously unselected package docker-ce-cli.
Preparing to unpack .../4-docker-ce-cli_5%3a19.03.11~3-0~ubuntu-bionic_amd64.deb ...
Unpacking docker-ce-cli (5:19.03.11~3-0~ubuntu-bionic) ...
Selecting previously unselected package docker-ce.
Preparing to unpack .../5-docker-ce_5%3a19.03.11~3-0~ubuntu-bionic_amd64.deb ...
Unpacking docker-ce (5:19.03.11~3-0~ubuntu-bionic) ...
Selecting previously unselected package libltdl7:amd64.
Preparing to unpack .../6-libltdl7_2.4.6-2_amd64.deb ...
Unpacking libltdl7:amd64 (2.4.6-2) ...
Setting up aufs-tools (1:4.9+20170918-1ubuntu1) ...
Setting up containerd.io (1.2.13-2) ...
Created symlink /etc/systemd/system/multi-user.target.wants/containerd.service → /lib/systemd/system/containerd.service.
Setting up cgroupfs-mount (1.4) ...
Setting up libltdl7:amd64 (2.4.6-2) ...
Setting up docker-ce-cli (5:19.03.11~3-0~ubuntu-bionic) ...
Setting up pigz (2.4-1) ...
Setting up docker-ce (5:19.03.11~3-0~ubuntu-bionic) ...
Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /lib/systemd/system/docker.service.
Created symlink /etc/systemd/system/sockets.target.wants/docker.socket → /lib/systemd/system/docker.socket.
Processing triggers for libc-bin (2.27-3ubuntu1.6) ...
Processing triggers for systemd (237-3ubuntu10.53) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
Processing triggers for ureadahead (0.100.0-21) ...
root@kubemaster:~# cat > /etc/docker/daemon.json <<EOF
> {
>   "exec-opts": ["native.cgroupdriver=systemd"],
>   "log-driver": "json-file",
>   "log-opts": {
>     "max-size": "100m"
>    },
>   "storage-driver": "overlay2"
> }
> EOF
root@kubemaster:~# mkdir -p /etc/systemd/system/docker.service.d
root@kubemaster:~# systemctl daemon-reload
root@kubemaster:~# systemctl restart docker
root@kubemaster:~# systemctl status docker.service
● docker.service - Docker Application Container Engine
   Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)
   Active: active (running) since Sat 2022-08-20 11:45:24 UTC; 1s ago
     Docs: https://docs.docker.com
 Main PID: 15874 (dockerd)
    Tasks: 10
   CGroup: /system.slice/docker.service
           └─15874 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock

Aug 20 11:45:24 kubemaster dockerd[15874]: time="2022-08-20T11:45:24.015978957Z" level=warning msg="Your kernel does not support swap memory limit"
Aug 20 11:45:24 kubemaster dockerd[15874]: time="2022-08-20T11:45:24.016472382Z" level=warning msg="Your kernel does not support cgroup rt period"
Aug 20 11:45:24 kubemaster dockerd[15874]: time="2022-08-20T11:45:24.016969132Z" level=warning msg="Your kernel does not support cgroup rt runtime"
Aug 20 11:45:24 kubemaster dockerd[15874]: time="2022-08-20T11:45:24.017597624Z" level=info msg="Loading containers: start."
Aug 20 11:45:24 kubemaster dockerd[15874]: time="2022-08-20T11:45:24.271722649Z" level=info msg="Default bridge (docker0) is assigned with an IP address 172.
Aug 20 11:45:24 kubemaster dockerd[15874]: time="2022-08-20T11:45:24.457764911Z" level=info msg="Loading containers: done."
Aug 20 11:45:24 kubemaster dockerd[15874]: time="2022-08-20T11:45:24.514013490Z" level=info msg="Docker daemon" commit=42e35e61f3 graphdriver(s)=overlay2 ver
Aug 20 11:45:24 kubemaster dockerd[15874]: time="2022-08-20T11:45:24.514904618Z" level=info msg="Daemon has completed initialization"
Aug 20 11:45:24 kubemaster systemd[1]: Started Docker Application Container Engine.
Aug 20 11:45:24 kubemaster dockerd[15874]: time="2022-08-20T11:45:24.598381566Z" level=info msg="API listen on /var/run/docker.sock"
root@kubemaster:~# 
```
```
root@kubenode01:~# apt-get update && apt-get install -y \
>   apt-transport-https ca-certificates curl software-properties-common gnupg2
Hit:1 http://archive.ubuntu.com/ubuntu bionic InRelease
Get:2 http://security.ubuntu.com/ubuntu bionic-security InRelease [88.7 kB]
Get:3 http://archive.ubuntu.com/ubuntu bionic-updates InRelease [88.7 kB]           
Get:4 http://archive.ubuntu.com/ubuntu bionic-backports InRelease [74.6 kB]                    
Get:5 http://archive.ubuntu.com/ubuntu bionic/universe amd64 Packages [8570 kB]
Get:6 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages [2365 kB]
Get:7 http://security.ubuntu.com/ubuntu bionic-security/main Translation-en [410 kB]
Get:8 http://security.ubuntu.com/ubuntu bionic-security/restricted amd64 Packages [859 kB]    
Get:9 http://security.ubuntu.com/ubuntu bionic-security/restricted Translation-en [118 kB]
Get:10 http://security.ubuntu.com/ubuntu bionic-security/universe amd64 Packages [1222 kB]
Get:11 http://security.ubuntu.com/ubuntu bionic-security/universe Translation-en [282 kB]
Get:12 http://security.ubuntu.com/ubuntu bionic-security/multiverse amd64 Packages [19.0 kB]
Get:13 http://security.ubuntu.com/ubuntu bionic-security/multiverse Translation-en [3836 B]
Get:14 http://archive.ubuntu.com/ubuntu bionic/universe Translation-en [4941 kB]                                                                            
Get:15 http://archive.ubuntu.com/ubuntu bionic/multiverse amd64 Packages [151 kB]                                                                           
Get:16 http://archive.ubuntu.com/ubuntu bionic/multiverse Translation-en [108 kB]                                                                           
Get:17 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages [2706 kB]                                                                        
Get:18 http://archive.ubuntu.com/ubuntu bionic-updates/main Translation-en [500 kB]                                                                         
Get:19 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 Packages [1837 kB]                                                                    
Get:20 http://archive.ubuntu.com/ubuntu bionic-updates/universe Translation-en [398 kB]                                                                     
Get:21 http://archive.ubuntu.com/ubuntu bionic-updates/multiverse amd64 Packages [24.9 kB]                                                                  
Get:22 http://archive.ubuntu.com/ubuntu bionic-updates/multiverse Translation-en [6012 B]                                                                   
Get:23 http://archive.ubuntu.com/ubuntu bionic-backports/main amd64 Packages [10.8 kB]                                                                      
Get:24 http://archive.ubuntu.com/ubuntu bionic-backports/main Translation-en [5016 B]                                                                       
Get:25 http://archive.ubuntu.com/ubuntu bionic-backports/universe amd64 Packages [11.6 kB]                                                                  
Get:26 http://archive.ubuntu.com/ubuntu bionic-backports/universe Translation-en [5864 B]                                                                   
Fetched 24.8 MB in 1min 1s (404 kB/s)                                                                                                                       
Reading package lists... Done
Reading package lists... Done
Building dependency tree       
Reading state information... Done
ca-certificates is already the newest version (20211016~18.04.1).
ca-certificates set to manually installed.
curl is already the newest version (7.58.0-2ubuntu3.19).
curl set to manually installed.
software-properties-common is already the newest version (0.96.24.32.18).
software-properties-common set to manually installed.
The following NEW packages will be installed:
  apt-transport-https gnupg2
0 upgraded, 2 newly installed, 0 to remove and 2 not upgraded.
Need to get 9648 B of archives.
After this operation, 206 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 apt-transport-https all 1.6.14 [4348 B]
Get:2 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 gnupg2 all 2.2.4-1ubuntu1.6 [5300 B]
Fetched 9648 B in 1s (11.6 kB/s)
Selecting previously unselected package apt-transport-https.
(Reading database ... 60132 files and directories currently installed.)
Preparing to unpack .../apt-transport-https_1.6.14_all.deb ...
Unpacking apt-transport-https (1.6.14) ...
Selecting previously unselected package gnupg2.
Preparing to unpack .../gnupg2_2.2.4-1ubuntu1.6_all.deb ...
Unpacking gnupg2 (2.2.4-1ubuntu1.6) ...
Setting up apt-transport-https (1.6.14) ...
Setting up gnupg2 (2.2.4-1ubuntu1.6) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
root@kubenode01:~# curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
OK
root@kubenode01:~# add-apt-repository \
>   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
>   $(lsb_release -cs) \
>   stable"
Get:1 https://download.docker.com/linux/ubuntu bionic InRelease [64.4 kB]
Hit:2 http://archive.ubuntu.com/ubuntu bionic InRelease                                                        
Get:3 https://download.docker.com/linux/ubuntu bionic/stable amd64 Packages [26.6 kB]                   
Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease                                        
Hit:5 http://archive.ubuntu.com/ubuntu bionic-updates InRelease                                
Hit:6 http://archive.ubuntu.com/ubuntu bionic-backports InRelease
Fetched 91.0 kB in 2s (52.8 kB/s)                 
Reading package lists... Done
root@kubenode01:~# apt-get update && apt-get install -y \
>   containerd.io=1.2.13-2 \
>   docker-ce=5:19.03.11~3-0~ubuntu-$(lsb_release -cs) \
>   docker-ce-cli=5:19.03.11~3-0~ubuntu-$(lsb_release -cs)
Hit:1 https://download.docker.com/linux/ubuntu bionic InRelease
Hit:2 http://security.ubuntu.com/ubuntu bionic-security InRelease                                                                   
Hit:3 http://archive.ubuntu.com/ubuntu bionic InRelease                                                                             
Hit:4 http://archive.ubuntu.com/ubuntu bionic-updates InRelease
Hit:5 http://archive.ubuntu.com/ubuntu bionic-backports InRelease
Reading package lists... Done                      
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  aufs-tools cgroupfs-mount libltdl7 pigz
The following NEW packages will be installed:
  aufs-tools cgroupfs-mount containerd.io docker-ce docker-ce-cli libltdl7 pigz
0 upgraded, 7 newly installed, 0 to remove and 2 not upgraded.
Need to get 85.3 MB of archives.
After this operation, 381 MB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu bionic/universe amd64 pigz amd64 2.4-1 [57.4 kB]
Get:2 https://download.docker.com/linux/ubuntu bionic/stable amd64 containerd.io amd64 1.2.13-2 [21.4 MB]
Get:3 http://archive.ubuntu.com/ubuntu bionic/universe amd64 aufs-tools amd64 1:4.9+20170918-1ubuntu1 [104 kB]
Get:4 http://archive.ubuntu.com/ubuntu bionic/universe amd64 cgroupfs-mount all 1.4 [6320 B]
Get:5 http://archive.ubuntu.com/ubuntu bionic/main amd64 libltdl7 amd64 2.4.6-2 [38.8 kB]
Get:6 https://download.docker.com/linux/ubuntu bionic/stable amd64 docker-ce-cli amd64 5:19.03.11~3-0~ubuntu-bionic [41.2 MB]
Get:7 https://download.docker.com/linux/ubuntu bionic/stable amd64 docker-ce amd64 5:19.03.11~3-0~ubuntu-bionic [22.5 MB]                                   
Fetched 85.3 MB in 17s (4965 kB/s)                                                                                                                          
Selecting previously unselected package pigz.
(Reading database ... 60143 files and directories currently installed.)
Preparing to unpack .../0-pigz_2.4-1_amd64.deb ...
Unpacking pigz (2.4-1) ...
Selecting previously unselected package aufs-tools.
Preparing to unpack .../1-aufs-tools_1%3a4.9+20170918-1ubuntu1_amd64.deb ...
Unpacking aufs-tools (1:4.9+20170918-1ubuntu1) ...
Selecting previously unselected package cgroupfs-mount.
Preparing to unpack .../2-cgroupfs-mount_1.4_all.deb ...
Unpacking cgroupfs-mount (1.4) ...
Selecting previously unselected package containerd.io.
Preparing to unpack .../3-containerd.io_1.2.13-2_amd64.deb ...
Unpacking containerd.io (1.2.13-2) ...
Selecting previously unselected package docker-ce-cli.
Preparing to unpack .../4-docker-ce-cli_5%3a19.03.11~3-0~ubuntu-bionic_amd64.deb ...
Unpacking docker-ce-cli (5:19.03.11~3-0~ubuntu-bionic) ...
Selecting previously unselected package docker-ce.
Preparing to unpack .../5-docker-ce_5%3a19.03.11~3-0~ubuntu-bionic_amd64.deb ...
Unpacking docker-ce (5:19.03.11~3-0~ubuntu-bionic) ...
Selecting previously unselected package libltdl7:amd64.
Preparing to unpack .../6-libltdl7_2.4.6-2_amd64.deb ...
Unpacking libltdl7:amd64 (2.4.6-2) ...
Setting up aufs-tools (1:4.9+20170918-1ubuntu1) ...
Setting up containerd.io (1.2.13-2) ...
Created symlink /etc/systemd/system/multi-user.target.wants/containerd.service → /lib/systemd/system/containerd.service.
Setting up cgroupfs-mount (1.4) ...
Setting up libltdl7:amd64 (2.4.6-2) ...
Setting up docker-ce-cli (5:19.03.11~3-0~ubuntu-bionic) ...
Setting up pigz (2.4-1) ...
Setting up docker-ce (5:19.03.11~3-0~ubuntu-bionic) ...
Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /lib/systemd/system/docker.service.
Created symlink /etc/systemd/system/sockets.target.wants/docker.socket → /lib/systemd/system/docker.socket.
Processing triggers for libc-bin (2.27-3ubuntu1.6) ...
Processing triggers for systemd (237-3ubuntu10.53) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
Processing triggers for ureadahead (0.100.0-21) ...
root@kubenode01:~# cat > /etc/docker/daemon.json <<EOF
> {
>   "exec-opts": ["native.cgroupdriver=systemd"],
>   "log-driver": "json-file",
>   "log-opts": {
>     "max-size": "100m"
>    },
>   "storage-driver": "overlay2"
> }
> EOF
root@kubenode01:~# mkdir -p /etc/systemd/system/docker.service.d
root@kubenode01:~# systemctl daemon-reload
root@kubenode01:~# systemctl restart docker
root@kubenode01:~# systemctl status docker.service
● docker.service - Docker Application Container Engine
   Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)
   Active: active (running) since Sat 2022-08-20 11:45:23 UTC; 1s ago
     Docs: https://docs.docker.com
 Main PID: 15841 (dockerd)
    Tasks: 11
   CGroup: /system.slice/docker.service
           └─15841 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock

Aug 20 11:45:22 kubenode01 dockerd[15841]: time="2022-08-20T11:45:22.951311501Z" level=warning msg="Your kernel does not support swap memory limit"
Aug 20 11:45:22 kubenode01 dockerd[15841]: time="2022-08-20T11:45:22.951497284Z" level=warning msg="Your kernel does not support cgroup rt period"
Aug 20 11:45:22 kubenode01 dockerd[15841]: time="2022-08-20T11:45:22.951539218Z" level=warning msg="Your kernel does not support cgroup rt runtime"
Aug 20 11:45:22 kubenode01 dockerd[15841]: time="2022-08-20T11:45:22.952653524Z" level=info msg="Loading containers: start."
Aug 20 11:45:23 kubenode01 dockerd[15841]: time="2022-08-20T11:45:23.248450646Z" level=info msg="Default bridge (docker0) is assigned with an IP address 172.
Aug 20 11:45:23 kubenode01 dockerd[15841]: time="2022-08-20T11:45:23.497843940Z" level=info msg="Loading containers: done."
Aug 20 11:45:23 kubenode01 dockerd[15841]: time="2022-08-20T11:45:23.566426711Z" level=info msg="Docker daemon" commit=42e35e61f3 graphdriver(s)=overlay2 ver
Aug 20 11:45:23 kubenode01 dockerd[15841]: time="2022-08-20T11:45:23.566586197Z" level=info msg="Daemon has completed initialization"
Aug 20 11:45:23 kubenode01 dockerd[15841]: time="2022-08-20T11:45:23.608330184Z" level=info msg="API listen on /var/run/docker.sock"
Aug 20 11:45:23 kubenode01 systemd[1]: Started Docker Application Container Engine.
root@kubenode01:~# 
```
```
root@kubenode02:~# apt-get update && apt-get install -y \
>   apt-transport-https ca-certificates curl software-properties-common gnupg2
Hit:1 http://archive.ubuntu.com/ubuntu bionic InRelease
Get:2 http://security.ubuntu.com/ubuntu bionic-security InRelease [88.7 kB]
Get:3 http://archive.ubuntu.com/ubuntu bionic-updates InRelease [88.7 kB]           
Get:4 http://archive.ubuntu.com/ubuntu bionic-backports InRelease [74.6 kB]                    
Get:5 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages [2365 kB]
Get:6 http://archive.ubuntu.com/ubuntu bionic/universe amd64 Packages [8570 kB]               
Get:7 http://security.ubuntu.com/ubuntu bionic-security/main Translation-en [410 kB]                                                                        
Get:8 http://security.ubuntu.com/ubuntu bionic-security/restricted amd64 Packages [859 kB]                                                                  
Get:9 http://security.ubuntu.com/ubuntu bionic-security/restricted Translation-en [118 kB]                                                                  
Get:10 http://security.ubuntu.com/ubuntu bionic-security/universe amd64 Packages [1222 kB]                                                                  
Get:11 http://security.ubuntu.com/ubuntu bionic-security/universe Translation-en [282 kB]                                                                   
Get:12 http://security.ubuntu.com/ubuntu bionic-security/multiverse amd64 Packages [19.0 kB]                                                                
Get:13 http://security.ubuntu.com/ubuntu bionic-security/multiverse Translation-en [3836 B]                                                                 
Get:14 http://archive.ubuntu.com/ubuntu bionic/universe Translation-en [4941 kB]                                                                            
Get:15 http://archive.ubuntu.com/ubuntu bionic/multiverse amd64 Packages [151 kB]                                                                           
Get:16 http://archive.ubuntu.com/ubuntu bionic/multiverse Translation-en [108 kB]                                                                           
Get:17 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages [2706 kB]                                                                        
Get:18 http://archive.ubuntu.com/ubuntu bionic-updates/main Translation-en [500 kB]                                                                         
Get:19 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 Packages [1837 kB]                                                                    
Get:20 http://archive.ubuntu.com/ubuntu bionic-updates/universe Translation-en [398 kB]                                                                     
Get:21 http://archive.ubuntu.com/ubuntu bionic-updates/multiverse amd64 Packages [24.9 kB]                                                                  
Get:22 http://archive.ubuntu.com/ubuntu bionic-updates/multiverse Translation-en [6012 B]                                                                   
Get:23 http://archive.ubuntu.com/ubuntu bionic-backports/main amd64 Packages [10.8 kB]                                                                      
Get:24 http://archive.ubuntu.com/ubuntu bionic-backports/main Translation-en [5016 B]                                                                       
Get:25 http://archive.ubuntu.com/ubuntu bionic-backports/universe amd64 Packages [11.6 kB]                                                                  
Get:26 http://archive.ubuntu.com/ubuntu bionic-backports/universe Translation-en [5864 B]                                                                   
Fetched 24.8 MB in 1min 1s (409 kB/s)                                                                                                                       
Reading package lists... Done
Reading package lists... Done
Building dependency tree       
Reading state information... Done
ca-certificates is already the newest version (20211016~18.04.1).
ca-certificates set to manually installed.
curl is already the newest version (7.58.0-2ubuntu3.19).
curl set to manually installed.
software-properties-common is already the newest version (0.96.24.32.18).
software-properties-common set to manually installed.
The following NEW packages will be installed:
  apt-transport-https gnupg2
0 upgraded, 2 newly installed, 0 to remove and 2 not upgraded.
Need to get 9648 B of archives.
After this operation, 206 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 apt-transport-https all 1.6.14 [4348 B]
Get:2 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 gnupg2 all 2.2.4-1ubuntu1.6 [5300 B]
Fetched 9648 B in 1s (11.5 kB/s) 
Selecting previously unselected package apt-transport-https.
(Reading database ... 60132 files and directories currently installed.)
Preparing to unpack .../apt-transport-https_1.6.14_all.deb ...
Unpacking apt-transport-https (1.6.14) ...
Selecting previously unselected package gnupg2.
Preparing to unpack .../gnupg2_2.2.4-1ubuntu1.6_all.deb ...
Unpacking gnupg2 (2.2.4-1ubuntu1.6) ...
Setting up apt-transport-https (1.6.14) ...
Setting up gnupg2 (2.2.4-1ubuntu1.6) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
root@kubenode02:~# curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
OK
root@kubenode02:~# add-apt-repository \
>   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
>   $(lsb_release -cs) \
>   stable"
Get:1 https://download.docker.com/linux/ubuntu bionic InRelease [64.4 kB]
Hit:2 http://archive.ubuntu.com/ubuntu bionic InRelease                                                        
Get:3 https://download.docker.com/linux/ubuntu bionic/stable amd64 Packages [26.6 kB]                   
Hit:4 http://archive.ubuntu.com/ubuntu bionic-updates InRelease                                          
Hit:5 http://security.ubuntu.com/ubuntu bionic-security InRelease                              
Hit:6 http://archive.ubuntu.com/ubuntu bionic-backports InRelease       
Fetched 91.0 kB in 2s (54.2 kB/s)                 
Reading package lists... Done
root@kubenode02:~# apt-get update && apt-get install -y \
>   containerd.io=1.2.13-2 \
>   docker-ce=5:19.03.11~3-0~ubuntu-$(lsb_release -cs) \
>   docker-ce-cli=5:19.03.11~3-0~ubuntu-$(lsb_release -cs)
Hit:1 https://download.docker.com/linux/ubuntu bionic InRelease
Hit:2 http://security.ubuntu.com/ubuntu bionic-security InRelease                                                                   
Hit:3 http://archive.ubuntu.com/ubuntu bionic InRelease                                                                             
Hit:4 http://archive.ubuntu.com/ubuntu bionic-updates InRelease
Hit:5 http://archive.ubuntu.com/ubuntu bionic-backports InRelease
Reading package lists... Done                     
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  aufs-tools cgroupfs-mount libltdl7 pigz
The following NEW packages will be installed:
  aufs-tools cgroupfs-mount containerd.io docker-ce docker-ce-cli libltdl7 pigz
0 upgraded, 7 newly installed, 0 to remove and 2 not upgraded.
Need to get 85.3 MB of archives.
After this operation, 381 MB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu bionic/universe amd64 pigz amd64 2.4-1 [57.4 kB]
Get:2 https://download.docker.com/linux/ubuntu bionic/stable amd64 containerd.io amd64 1.2.13-2 [21.4 MB]
Get:3 http://archive.ubuntu.com/ubuntu bionic/universe amd64 aufs-tools amd64 1:4.9+20170918-1ubuntu1 [104 kB]
Get:4 http://archive.ubuntu.com/ubuntu bionic/universe amd64 cgroupfs-mount all 1.4 [6320 B]
Get:5 http://archive.ubuntu.com/ubuntu bionic/main amd64 libltdl7 amd64 2.4.6-2 [38.8 kB]
Get:6 https://download.docker.com/linux/ubuntu bionic/stable amd64 docker-ce-cli amd64 5:19.03.11~3-0~ubuntu-bionic [41.2 MB]
Get:7 https://download.docker.com/linux/ubuntu bionic/stable amd64 docker-ce amd64 5:19.03.11~3-0~ubuntu-bionic [22.5 MB]                                   
Fetched 85.3 MB in 17s (4887 kB/s)                                                                                                                          
Selecting previously unselected package pigz.
(Reading database ... 60143 files and directories currently installed.)
Preparing to unpack .../0-pigz_2.4-1_amd64.deb ...
Unpacking pigz (2.4-1) ...
Selecting previously unselected package aufs-tools.
Preparing to unpack .../1-aufs-tools_1%3a4.9+20170918-1ubuntu1_amd64.deb ...
Unpacking aufs-tools (1:4.9+20170918-1ubuntu1) ...
Selecting previously unselected package cgroupfs-mount.
Preparing to unpack .../2-cgroupfs-mount_1.4_all.deb ...
Unpacking cgroupfs-mount (1.4) ...
Selecting previously unselected package containerd.io.
Preparing to unpack .../3-containerd.io_1.2.13-2_amd64.deb ...
Unpacking containerd.io (1.2.13-2) ...
Selecting previously unselected package docker-ce-cli.
Preparing to unpack .../4-docker-ce-cli_5%3a19.03.11~3-0~ubuntu-bionic_amd64.deb ...
Unpacking docker-ce-cli (5:19.03.11~3-0~ubuntu-bionic) ...
Selecting previously unselected package docker-ce.
Preparing to unpack .../5-docker-ce_5%3a19.03.11~3-0~ubuntu-bionic_amd64.deb ...
Unpacking docker-ce (5:19.03.11~3-0~ubuntu-bionic) ...
Selecting previously unselected package libltdl7:amd64.
Preparing to unpack .../6-libltdl7_2.4.6-2_amd64.deb ...
Unpacking libltdl7:amd64 (2.4.6-2) ...
Setting up aufs-tools (1:4.9+20170918-1ubuntu1) ...
Setting up containerd.io (1.2.13-2) ...
Created symlink /etc/systemd/system/multi-user.target.wants/containerd.service → /lib/systemd/system/containerd.service.
Setting up cgroupfs-mount (1.4) ...
Setting up libltdl7:amd64 (2.4.6-2) ...
Setting up docker-ce-cli (5:19.03.11~3-0~ubuntu-bionic) ...
Setting up pigz (2.4-1) ...
Setting up docker-ce (5:19.03.11~3-0~ubuntu-bionic) ...
Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /lib/systemd/system/docker.service.
Created symlink /etc/systemd/system/sockets.target.wants/docker.socket → /lib/systemd/system/docker.socket.
Processing triggers for libc-bin (2.27-3ubuntu1.6) ...
Processing triggers for systemd (237-3ubuntu10.53) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
Processing triggers for ureadahead (0.100.0-21) ...
root@kubenode02:~# cat > /etc/docker/daemon.json <<EOF
> {
>   "exec-opts": ["native.cgroupdriver=systemd"],
>   "log-driver": "json-file",
>   "log-opts": {
>     "max-size": "100m"
>    },
>   "storage-driver": "overlay2"
> }
> EOF
root@kubenode02:~# mkdir -p /etc/systemd/system/docker.service.d
root@kubenode02:~# systemctl daemon-reload
root@kubenode02:~# systemctl restart docker
root@kubenode02:~# systemctl status docker.service
● docker.service - Docker Application Container Engine
   Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)
   Active: active (running) since Sat 2022-08-20 11:45:24 UTC; 1s ago
     Docs: https://docs.docker.com
 Main PID: 15862 (dockerd)
    Tasks: 10
   CGroup: /system.slice/docker.service
           └─15862 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock

Aug 20 11:45:24 kubenode02 dockerd[15862]: time="2022-08-20T11:45:24.107204371Z" level=warning msg="Your kernel does not support swap memory limit"
Aug 20 11:45:24 kubenode02 dockerd[15862]: time="2022-08-20T11:45:24.107310167Z" level=warning msg="Your kernel does not support cgroup rt period"
Aug 20 11:45:24 kubenode02 dockerd[15862]: time="2022-08-20T11:45:24.107331679Z" level=warning msg="Your kernel does not support cgroup rt runtime"
Aug 20 11:45:24 kubenode02 dockerd[15862]: time="2022-08-20T11:45:24.107734389Z" level=info msg="Loading containers: start."
Aug 20 11:45:24 kubenode02 dockerd[15862]: time="2022-08-20T11:45:24.337787631Z" level=info msg="Default bridge (docker0) is assigned with an IP address 172.
Aug 20 11:45:24 kubenode02 dockerd[15862]: time="2022-08-20T11:45:24.541988274Z" level=info msg="Loading containers: done."
Aug 20 11:45:24 kubenode02 dockerd[15862]: time="2022-08-20T11:45:24.630967033Z" level=info msg="Docker daemon" commit=42e35e61f3 graphdriver(s)=overlay2 ver
Aug 20 11:45:24 kubenode02 dockerd[15862]: time="2022-08-20T11:45:24.631529741Z" level=info msg="Daemon has completed initialization"
Aug 20 11:45:24 kubenode02 systemd[1]: Started Docker Application Container Engine.
Aug 20 11:45:24 kubenode02 dockerd[15862]: time="2022-08-20T11:45:24.672239500Z" level=info msg="API listen on /var/run/docker.sock"
root@kubenode02:~# 
```
- kubeadm、kubelet、kubectlのインストール
```bash
sudo apt-get update && sudo apt-get install -y apt-transport-https curl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo   apt-key add -
cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
deb https://apt.kubernetes.io/ kubernetes-xenial main
EOF
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```
```
root@kubemaster:~# sudo apt-get update && sudo apt-get install -y apt-transport-https curl
Hit:1 https://download.docker.com/linux/ubuntu bionic InRelease
Hit:2 http://archive.ubuntu.com/ubuntu bionic InRelease                                                                               
Hit:3 http://security.ubuntu.com/ubuntu bionic-security InRelease       
Hit:4 http://archive.ubuntu.com/ubuntu bionic-updates InRelease         
Hit:5 http://archive.ubuntu.com/ubuntu bionic-backports InRelease
Reading package lists... Done                      
Reading package lists... Done
Building dependency tree       
Reading state information... Done
curl is already the newest version (7.58.0-2ubuntu3.19).
apt-transport-https is already the newest version (1.6.14).
0 upgraded, 0 newly installed, 0 to remove and 5 not upgraded.
root@kubemaster:~# curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo   apt-key add -
OK
root@kubemaster:~# cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
> deb https://apt.kubernetes.io/ kubernetes-xenial main
> EOF
deb https://apt.kubernetes.io/ kubernetes-xenial main
root@kubemaster:~# sudo apt-get update
Hit:1 https://download.docker.com/linux/ubuntu bionic InRelease
Hit:2 http://archive.ubuntu.com/ubuntu bionic InRelease                                                                    
Hit:3 http://security.ubuntu.com/ubuntu bionic-security InRelease                                                          
Hit:5 http://archive.ubuntu.com/ubuntu bionic-updates InRelease                                
Hit:6 http://archive.ubuntu.com/ubuntu bionic-backports InRelease
Get:4 https://packages.cloud.google.com/apt kubernetes-xenial InRelease [9383 B]      
Get:7 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 Packages [58.5 kB]
Fetched 67.8 kB in 2s (31.5 kB/s)  
Reading package lists... Done
root@kubemaster:~# sudo apt-get install -y kubelet kubeadm kubectl
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  conntrack cri-tools kubernetes-cni socat
The following NEW packages will be installed:
  conntrack cri-tools kubeadm kubectl kubelet kubernetes-cni socat
0 upgraded, 7 newly installed, 0 to remove and 5 not upgraded.
Need to get 75.2 MB of archives.
After this operation, 313 MB of additional disk space will be used.
Get:2 http://archive.ubuntu.com/ubuntu bionic/main amd64 conntrack amd64 1:1.4.4+snapshot20161117-6ubuntu2 [30.6 kB]
Get:1 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 cri-tools amd64 1.24.2-00 [12.3 MB]         
Get:6 http://archive.ubuntu.com/ubuntu bionic/main amd64 socat amd64 1.7.3.2-2ubuntu2 [342 kB]
Get:3 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubernetes-cni amd64 0.8.7-00 [25.0 MB]
Get:4 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubelet amd64 1.24.4-00 [19.2 MB]                                                  
Get:5 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubectl amd64 1.24.4-00 [9317 kB]                                                  
Get:7 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubeadm amd64 1.24.4-00 [9004 kB]                                                  
Fetched 75.2 MB in 9s (7913 kB/s)                                                                                                                           
Selecting previously unselected package conntrack.
(Reading database ... 60455 files and directories currently installed.)
Preparing to unpack .../0-conntrack_1%3a1.4.4+snapshot20161117-6ubuntu2_amd64.deb ...
Unpacking conntrack (1:1.4.4+snapshot20161117-6ubuntu2) ...
Selecting previously unselected package cri-tools.
Preparing to unpack .../1-cri-tools_1.24.2-00_amd64.deb ...
Unpacking cri-tools (1.24.2-00) ...
Selecting previously unselected package kubernetes-cni.
Preparing to unpack .../2-kubernetes-cni_0.8.7-00_amd64.deb ...
Unpacking kubernetes-cni (0.8.7-00) ...
Selecting previously unselected package socat.
Preparing to unpack .../3-socat_1.7.3.2-2ubuntu2_amd64.deb ...
Unpacking socat (1.7.3.2-2ubuntu2) ...
Selecting previously unselected package kubelet.
Preparing to unpack .../4-kubelet_1.24.4-00_amd64.deb ...
Unpacking kubelet (1.24.4-00) ...
Selecting previously unselected package kubectl.
Preparing to unpack .../5-kubectl_1.24.4-00_amd64.deb ...
Unpacking kubectl (1.24.4-00) ...
Selecting previously unselected package kubeadm.
Preparing to unpack .../6-kubeadm_1.24.4-00_amd64.deb ...
Unpacking kubeadm (1.24.4-00) ...
Setting up conntrack (1:1.4.4+snapshot20161117-6ubuntu2) ...
Setting up kubernetes-cni (0.8.7-00) ...
Setting up cri-tools (1.24.2-00) ...
Setting up socat (1.7.3.2-2ubuntu2) ...
Setting up kubelet (1.24.4-00) ...
Created symlink /etc/systemd/system/multi-user.target.wants/kubelet.service → /lib/systemd/system/kubelet.service.
Setting up kubectl (1.24.4-00) ...
Setting up kubeadm (1.24.4-00) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
root@kubemaster:~# 
```
```
root@kubenode01:~# sudo apt-get update && sudo apt-get install -y apt-transport-https curl
Hit:1 https://download.docker.com/linux/ubuntu bionic InRelease
Hit:2 http://archive.ubuntu.com/ubuntu bionic InRelease                                                                               
Hit:3 http://security.ubuntu.com/ubuntu bionic-security InRelease       
Hit:4 http://archive.ubuntu.com/ubuntu bionic-updates InRelease         
Hit:5 http://archive.ubuntu.com/ubuntu bionic-backports InRelease
Reading package lists... Done                      
Reading package lists... Done
Building dependency tree       
Reading state information... Done
curl is already the newest version (7.58.0-2ubuntu3.19).
apt-transport-https is already the newest version (1.6.14).
0 upgraded, 0 newly installed, 0 to remove and 5 not upgraded.
root@kubenode01:~# curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo   apt-key add -
OK
root@kubenode01:~# cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
> deb https://apt.kubernetes.io/ kubernetes-xenial main
> EOF
deb https://apt.kubernetes.io/ kubernetes-xenial main
root@kubenode01:~# sudo apt-get update
Hit:1 https://download.docker.com/linux/ubuntu bionic InRelease
Hit:2 http://archive.ubuntu.com/ubuntu bionic InRelease                                                                           
Hit:3 http://security.ubuntu.com/ubuntu bionic-security InRelease                                                                 
Hit:5 http://archive.ubuntu.com/ubuntu bionic-updates InRelease          
Hit:6 http://archive.ubuntu.com/ubuntu bionic-backports InRelease
Get:4 https://packages.cloud.google.com/apt kubernetes-xenial InRelease [9383 B]       
Get:7 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 Packages [58.5 kB]
Fetched 67.8 kB in 2s (31.0 kB/s)  
Reading package lists... Done
root@kubenode01:~# sudo apt-get install -y kubelet kubeadm kubectl
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  conntrack cri-tools kubernetes-cni socat
The following NEW packages will be installed:
  conntrack cri-tools kubeadm kubectl kubelet kubernetes-cni socat
0 upgraded, 7 newly installed, 0 to remove and 5 not upgraded.
Need to get 75.2 MB of archives.
After this operation, 313 MB of additional disk space will be used.
Get:2 http://archive.ubuntu.com/ubuntu bionic/main amd64 conntrack amd64 1:1.4.4+snapshot20161117-6ubuntu2 [30.6 kB]
Get:1 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 cri-tools amd64 1.24.2-00 [12.3 MB]
Get:5 http://archive.ubuntu.com/ubuntu bionic/main amd64 socat amd64 1.7.3.2-2ubuntu2 [342 kB]
Get:3 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubernetes-cni amd64 0.8.7-00 [25.0 MB]
Get:4 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubelet amd64 1.24.4-00 [19.2 MB]
Get:6 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubectl amd64 1.24.4-00 [9317 kB]
Get:7 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubeadm amd64 1.24.4-00 [9004 kB]
Fetched 75.2 MB in 5s (16.6 MB/s)
Selecting previously unselected package conntrack.
(Reading database ... 60455 files and directories currently installed.)
Preparing to unpack .../0-conntrack_1%3a1.4.4+snapshot20161117-6ubuntu2_amd64.deb ...
Unpacking conntrack (1:1.4.4+snapshot20161117-6ubuntu2) ...
Selecting previously unselected package cri-tools.
Preparing to unpack .../1-cri-tools_1.24.2-00_amd64.deb ...
Unpacking cri-tools (1.24.2-00) ...
Selecting previously unselected package kubernetes-cni.
Preparing to unpack .../2-kubernetes-cni_0.8.7-00_amd64.deb ...
Unpacking kubernetes-cni (0.8.7-00) ...
Selecting previously unselected package socat.
Preparing to unpack .../3-socat_1.7.3.2-2ubuntu2_amd64.deb ...
Unpacking socat (1.7.3.2-2ubuntu2) ...
Selecting previously unselected package kubelet.
Preparing to unpack .../4-kubelet_1.24.4-00_amd64.deb ...
Unpacking kubelet (1.24.4-00) ...
Selecting previously unselected package kubectl.
Preparing to unpack .../5-kubectl_1.24.4-00_amd64.deb ...
Unpacking kubectl (1.24.4-00) ...
Selecting previously unselected package kubeadm.
Preparing to unpack .../6-kubeadm_1.24.4-00_amd64.deb ...
Unpacking kubeadm (1.24.4-00) ...
Setting up conntrack (1:1.4.4+snapshot20161117-6ubuntu2) ...
Setting up kubernetes-cni (0.8.7-00) ...
Setting up cri-tools (1.24.2-00) ...
Setting up socat (1.7.3.2-2ubuntu2) ...
Setting up kubelet (1.24.4-00) ...
Created symlink /etc/systemd/system/multi-user.target.wants/kubelet.service → /lib/systemd/system/kubelet.service.
Setting up kubectl (1.24.4-00) ...
Setting up kubeadm (1.24.4-00) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
root@kubenode01:~# 
```
```
root@kubenode02:~# sudo apt-get update && sudo apt-get install -y apt-transport-https curl
Hit:1 https://download.docker.com/linux/ubuntu bionic InRelease
Hit:2 http://security.ubuntu.com/ubuntu bionic-security InRelease                                                                 
Hit:3 http://archive.ubuntu.com/ubuntu bionic InRelease                                                                           
Hit:4 http://archive.ubuntu.com/ubuntu bionic-updates InRelease
Hit:5 http://archive.ubuntu.com/ubuntu bionic-backports InRelease
Reading package lists... Done                     
Reading package lists... Done
Building dependency tree       
Reading state information... Done
curl is already the newest version (7.58.0-2ubuntu3.19).
apt-transport-https is already the newest version (1.6.14).
0 upgraded, 0 newly installed, 0 to remove and 5 not upgraded.
root@kubenode02:~# curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo   apt-key add -
OK
root@kubenode02:~# cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
> deb https://apt.kubernetes.io/ kubernetes-xenial main
> EOF
deb https://apt.kubernetes.io/ kubernetes-xenial main
root@kubenode02:~# sudo apt-get update
Hit:1 https://download.docker.com/linux/ubuntu bionic InRelease
Hit:2 http://archive.ubuntu.com/ubuntu bionic InRelease                                                                             
Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease                                                                   
Hit:5 http://archive.ubuntu.com/ubuntu bionic-updates InRelease         
Hit:6 http://archive.ubuntu.com/ubuntu bionic-backports InRelease                  
Get:3 https://packages.cloud.google.com/apt kubernetes-xenial InRelease [9383 B]       
Get:7 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 Packages [58.5 kB]
Fetched 67.8 kB in 2s (31.5 kB/s) 
Reading package lists... Done
root@kubenode02:~# sudo apt-get install -y kubelet kubeadm kubectl
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  conntrack cri-tools kubernetes-cni socat
The following NEW packages will be installed:
  conntrack cri-tools kubeadm kubectl kubelet kubernetes-cni socat
0 upgraded, 7 newly installed, 0 to remove and 5 not upgraded.
Need to get 75.2 MB of archives.
After this operation, 313 MB of additional disk space will be used.
Get:2 http://archive.ubuntu.com/ubuntu bionic/main amd64 conntrack amd64 1:1.4.4+snapshot20161117-6ubuntu2 [30.6 kB]
Get:7 http://archive.ubuntu.com/ubuntu bionic/main amd64 socat amd64 1.7.3.2-2ubuntu2 [342 kB]                        
Get:1 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 cri-tools amd64 1.24.2-00 [12.3 MB]
Get:3 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubernetes-cni amd64 0.8.7-00 [25.0 MB]
Get:4 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubelet amd64 1.24.4-00 [19.2 MB]
Get:5 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubectl amd64 1.24.4-00 [9317 kB]                                                  
Get:6 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubeadm amd64 1.24.4-00 [9004 kB]                                                  
Fetched 75.2 MB in 8s (9342 kB/s)                                                                                                                           
Selecting previously unselected package conntrack.
(Reading database ... 60455 files and directories currently installed.)
Preparing to unpack .../0-conntrack_1%3a1.4.4+snapshot20161117-6ubuntu2_amd64.deb ...
Unpacking conntrack (1:1.4.4+snapshot20161117-6ubuntu2) ...
Selecting previously unselected package cri-tools.
Preparing to unpack .../1-cri-tools_1.24.2-00_amd64.deb ...
Unpacking cri-tools (1.24.2-00) ...
Selecting previously unselected package kubernetes-cni.
Preparing to unpack .../2-kubernetes-cni_0.8.7-00_amd64.deb ...
Unpacking kubernetes-cni (0.8.7-00) ...
Selecting previously unselected package socat.
Preparing to unpack .../3-socat_1.7.3.2-2ubuntu2_amd64.deb ...
Unpacking socat (1.7.3.2-2ubuntu2) ...
Selecting previously unselected package kubelet.
Preparing to unpack .../4-kubelet_1.24.4-00_amd64.deb ...
Unpacking kubelet (1.24.4-00) ...
Selecting previously unselected package kubectl.
Preparing to unpack .../5-kubectl_1.24.4-00_amd64.deb ...
Unpacking kubectl (1.24.4-00) ...
Selecting previously unselected package kubeadm.
Preparing to unpack .../6-kubeadm_1.24.4-00_amd64.deb ...
Unpacking kubeadm (1.24.4-00) ...
Setting up conntrack (1:1.4.4+snapshot20161117-6ubuntu2) ...
Setting up kubernetes-cni (0.8.7-00) ...
Setting up cri-tools (1.24.2-00) ...
Setting up socat (1.7.3.2-2ubuntu2) ...
Setting up kubelet (1.24.4-00) ...
Created symlink /etc/systemd/system/multi-user.target.wants/kubelet.service → /lib/systemd/system/kubelet.service.
Setting up kubectl (1.24.4-00) ...
Setting up kubeadm (1.24.4-00) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
root@kubenode02:~# 
```
- kubeadmを使用したクラスターの作成　※マスターノードで実行※
```bash
ifconfig enp0s8
kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=192.168.56.2
logout
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
echo "kubeadm join 192.168.56.2:6443 --token nn7d5f.63zmuuhpk7e1cq7x \
        --discovery-token-ca-cert-hash sha256:7991672102244985b96f13713de43e85246fd165972d86d300f70a7120e116fc"
kubectl get nodes
kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"
echo "kubeadm join 192.168.56.2:6443 --token nn7d5f.63zmuuhpk7e1cq7x \
        --discovery-token-ca-cert-hash sha256:7991672102244985b96f13713de43e85246fd165972d86d300f70a7120e116fc"
```
`kubeadm init` コマンドの実行時にエラーが発生したときは次のコマンドを実行し、再度 `kubeadm init` コマンドを実行する
```
cd /etc/containerd/
rm ./config.toml 
systemctl restart containerd.service
systemctl status containerd.service
cd
```
```
root@kubemaster:~# ifconfig enp0s8
enp0s8: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.56.2  netmask 255.255.255.0  broadcast 192.168.56.255
        inet6 fe80::a00:27ff:fe6b:e4bf  prefixlen 64  scopeid 0x20<link>
        ether 08:00:27:6b:e4:bf  txqueuelen 1000  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 22  bytes 1676 (1.6 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

root@kubemaster:~#  kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=192.168.56.2
[init] Using Kubernetes version: v1.24.4
[preflight] Running pre-flight checks
error execution phase preflight: [preflight] Some fatal errors occurred:
        [ERROR CRI]: container runtime is not running: output: E0820 12:14:55.807527   22390 remote_runtime.go:925] "Status from runtime service failed" err="rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService"
time="2022-08-20T12:14:55Z" level=fatal msg="getting status of runtime: rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService"
, error: exit status 1
[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
To see the stack trace of this error execute with --v=5 or higher
root@kubemaster:~# cd /etc/containerd/
root@kubemaster:/etc/containerd# ls -al 
total 12
drwxr-xr-x  2 root root 4096 Aug 20 11:44 .
drwxr-xr-x 95 root root 4096 Aug 20 11:50 ..
-rw-r--r--  1 root root  886 May  1  2020 config.toml
root@kubemaster:/etc/containerd# 
root@kubemaster:/etc/containerd# rm ./config.toml 
root@kubemaster:/etc/containerd# systemctl restart containerd.service
root@kubemaster:/etc/containerd# systemctl status containerd.service
● containerd.service - containerd container runtime
   Loaded: loaded (/lib/systemd/system/containerd.service; enabled; vendor preset: enabled)
   Active: active (running) since Sat 2022-08-20 12:16:47 UTC; 12s ago
     Docs: https://containerd.io
  Process: 22796 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS)
 Main PID: 22801 (containerd)
    Tasks: 10
   CGroup: /system.slice/containerd.service
           └─22801 /usr/bin/containerd

Aug 20 12:16:48 kubemaster containerd[22801]: time="2022-08-20T12:16:48.006044029Z" level=info msg="Get image filesystem path "/var/lib/containerd/io.contain
Aug 20 12:16:48 kubemaster containerd[22801]: time="2022-08-20T12:16:48.006297933Z" level=error msg="Failed to load cni during init, please check CRI plugin 
Aug 20 12:16:48 kubemaster containerd[22801]: time="2022-08-20T12:16:48.006651360Z" level=info msg="loading plugin "io.containerd.grpc.v1.introspection"..." 
Aug 20 12:16:48 kubemaster containerd[22801]: time="2022-08-20T12:16:48.006978943Z" level=info msg=serving... address="/run/containerd/containerd.sock"
Aug 20 12:16:48 kubemaster containerd[22801]: time="2022-08-20T12:16:48.006999067Z" level=info msg="containerd successfully booted in 0.014512s"
Aug 20 12:16:48 kubemaster containerd[22801]: time="2022-08-20T12:16:48.027785398Z" level=info msg="Start subscribing containerd event"
Aug 20 12:16:48 kubemaster containerd[22801]: time="2022-08-20T12:16:48.027885580Z" level=info msg="Start recovering state"
Aug 20 12:16:48 kubemaster containerd[22801]: time="2022-08-20T12:16:48.028127184Z" level=info msg="Start event monitor"
Aug 20 12:16:48 kubemaster containerd[22801]: time="2022-08-20T12:16:48.028161374Z" level=info msg="Start snapshots syncer"
Aug 20 12:16:48 kubemaster containerd[22801]: time="2022-08-20T12:16:48.028178143Z" level=info msg="Start streaming server"
root@kubemaster:/etc/containerd# cd
root@kubemaster:~# kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=192.168.56.2
[init] Using Kubernetes version: v1.24.4
[preflight] Running pre-flight checks
[preflight] Pulling images required for setting up a Kubernetes cluster
[preflight] This might take a minute or two, depending on the speed of your internet connection
[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'
[certs] Using certificateDir folder "/etc/kubernetes/pki"
[certs] Generating "ca" certificate and key
[certs] Generating "apiserver" certificate and key
[certs] apiserver serving cert is signed for DNS names [kubemaster kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.56.2]
[certs] Generating "apiserver-kubelet-client" certificate and key
[certs] Generating "front-proxy-ca" certificate and key
[certs] Generating "front-proxy-client" certificate and key
[certs] Generating "etcd/ca" certificate and key
[certs] Generating "etcd/server" certificate and key
[certs] etcd/server serving cert is signed for DNS names [kubemaster localhost] and IPs [192.168.56.2 127.0.0.1 ::1]
[certs] Generating "etcd/peer" certificate and key
[certs] etcd/peer serving cert is signed for DNS names [kubemaster localhost] and IPs [192.168.56.2 127.0.0.1 ::1]
[certs] Generating "etcd/healthcheck-client" certificate and key
[certs] Generating "apiserver-etcd-client" certificate and key
[certs] Generating "sa" key and public key
[kubeconfig] Using kubeconfig folder "/etc/kubernetes"
[kubeconfig] Writing "admin.conf" kubeconfig file
[kubeconfig] Writing "kubelet.conf" kubeconfig file
[kubeconfig] Writing "controller-manager.conf" kubeconfig file
[kubeconfig] Writing "scheduler.conf" kubeconfig file
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Starting the kubelet
[control-plane] Using manifest folder "/etc/kubernetes/manifests"
[control-plane] Creating static Pod manifest for "kube-apiserver"
[control-plane] Creating static Pod manifest for "kube-controller-manager"
[control-plane] Creating static Pod manifest for "kube-scheduler"
[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"
[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests". This can take up to 4m0s
[apiclient] All control plane components are healthy after 31.516542 seconds
[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
[kubelet] Creating a ConfigMap "kubelet-config" in namespace kube-system with the configuration for the kubelets in the cluster
[upload-certs] Skipping phase. Please see --upload-certs
[mark-control-plane] Marking the node kubemaster as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]
[mark-control-plane] Marking the node kubemaster as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule node-role.kubernetes.io/control-plane:NoSchedule]
[bootstrap-token] Using token: nn7d5f.63zmuuhpk7e1cq7x
[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes
[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace
[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.56.2:6443 --token nn7d5f.63zmuuhpk7e1cq7x \
        --discovery-token-ca-cert-hash sha256:7991672102244985b96f13713de43e85246fd165972d86d300f70a7120e116fc 
root@kubemaster:~# logout
vagrant@kubemaster:~$ mkdir -p $HOME/.kube
vagrant@kubemaster:~$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
vagrant@kubemaster:~$ sudo chown $(id -u):$(id -g) $HOME/.kube/config
vagrant@kubemaster:~$ echo "kubeadm join 192.168.56.2:6443 --token nn7d5f.63zmuuhpk7e1cq7x \
>         --discovery-token-ca-cert-hash sha256:7991672102244985b96f13713de43e85246fd165972d86d300f70a7120e116fc"
kubeadm join 192.168.56.2:6443 --token nn7d5f.63zmuuhpk7e1cq7x         --discovery-token-ca-cert-hash sha256:7991672102244985b96f13713de43e85246fd165972d86d300f70a7120e116fc
vagrant@kubemaster:~$ kubectl get nodes
NAME         STATUS     ROLES           AGE    VERSION
kubemaster   NotReady   control-plane   7m7s   v1.24.4
vagrant@kubemaster:~$ kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"
WARNING: This version information is deprecated and will be replaced with the output from kubectl version --short.  Use --output=yaml|json to get the full version.
serviceaccount/weave-net created
clusterrole.rbac.authorization.k8s.io/weave-net created
clusterrolebinding.rbac.authorization.k8s.io/weave-net created
role.rbac.authorization.k8s.io/weave-net created
rolebinding.rbac.authorization.k8s.io/weave-net created
daemonset.apps/weave-net created
vagrant@kubemaster:~$ 
```
- ワーカーノードをクラスターに追加
```bash
kubeadm join 192.168.56.2:6443 --token nn7d5f.63zmuuhpk7e1cq7x --discovery-token-ca-cert-hash sha256:7991672102244985b96f13713de43e85246fd165972d86d300f70a7120e116fc
```
```
root@kubenode01:~# kubeadm join 192.168.56.2:6443 --token nn7d5f.63zmuuhpk7e1cq7x --discovery-token-ca-cert-hash sha256:7991672102244985b96f13713de43e85246fd165972d86d300f70a7120e116fc
[preflight] Running pre-flight checks
error execution phase preflight: [preflight] Some fatal errors occurred:
        [ERROR CRI]: container runtime is not running: output: E0820 12:33:22.780169   25954 remote_runtime.go:925] "Status from runtime service failed" err="rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService"
time="2022-08-20T12:33:22Z" level=fatal msg="getting status of runtime: rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService"
, error: exit status 1
[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
To see the stack trace of this error execute with --v=5 or higher
root@kubenode01:~# cd /etc/containerd/
root@kubenode01:/etc/containerd# ls
config.toml
root@kubenode01:/etc/containerd# rm ./config.toml 
root@kubenode01:/etc/containerd# cd
root@kubenode01:~# systemctl restart containerd.service
root@kubenode01:~# systemctl status containerd.service
● containerd.service - containerd container runtime
   Loaded: loaded (/lib/systemd/system/containerd.service; enabled; vendor preset: enabled)
   Active: active (running) since Sat 2022-08-20 12:39:18 UTC; 7s ago
     Docs: https://containerd.io
  Process: 27160 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS)
 Main PID: 27163 (containerd)
    Tasks: 10
   CGroup: /system.slice/containerd.service
           └─27163 /usr/bin/containerd

Aug 20 12:39:19 kubenode01 containerd[27163]: time="2022-08-20T12:39:19.057920604Z" level=info msg="Get image filesystem path "/var/lib/containerd/io.contain
Aug 20 12:39:19 kubenode01 containerd[27163]: time="2022-08-20T12:39:19.059930572Z" level=error msg="Failed to load cni during init, please check CRI plugin 
Aug 20 12:39:19 kubenode01 containerd[27163]: time="2022-08-20T12:39:19.060535642Z" level=info msg="loading plugin "io.containerd.grpc.v1.introspection"..." 
Aug 20 12:39:19 kubenode01 containerd[27163]: time="2022-08-20T12:39:19.066435985Z" level=info msg=serving... address="/run/containerd/containerd.sock"
Aug 20 12:39:19 kubenode01 containerd[27163]: time="2022-08-20T12:39:19.066644615Z" level=info msg="containerd successfully booted in 0.036258s"
Aug 20 12:39:19 kubenode01 containerd[27163]: time="2022-08-20T12:39:19.075802497Z" level=info msg="Start subscribing containerd event"
Aug 20 12:39:19 kubenode01 containerd[27163]: time="2022-08-20T12:39:19.078256009Z" level=info msg="Start recovering state"
Aug 20 12:39:19 kubenode01 containerd[27163]: time="2022-08-20T12:39:19.078497281Z" level=info msg="Start event monitor"
Aug 20 12:39:19 kubenode01 containerd[27163]: time="2022-08-20T12:39:19.078775710Z" level=info msg="Start snapshots syncer"
Aug 20 12:39:19 kubenode01 containerd[27163]: time="2022-08-20T12:39:19.078799069Z" level=info msg="Start streaming server"
root@kubenode01:~# kubeadm join 192.168.56.2:6443 --token nn7d5f.63zmuuhpk7e1cq7x         --discovery-token-ca-cert-hash sha256:7991672102244985b96f13713de43e85246fd165972d86d300f70a7120e116fc
[preflight] Running pre-flight checks
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Starting the kubelet
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.

root@kubenode01:~# 
```
```
root@kubenode02:~# kubeadm join 192.168.56.2:6443 --token nn7d5f.63zmuuhpk7e1cq7x --discovery-token-ca-cert-hash sha256:7991672102244985b96f13713de43e85246fd165972d86d300f70a7120e116fc
[preflight] Running pre-flight checks
error execution phase preflight: [preflight] Some fatal errors occurred:
        [ERROR CRI]: container runtime is not running: output: E0820 12:33:30.036024   26083 remote_runtime.go:925] "Status from runtime service failed" err="rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService"
time="2022-08-20T12:33:30Z" level=fatal msg="getting status of runtime: rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService"
, error: exit status 1
[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
To see the stack trace of this error execute with --v=5 or higher
root@kubenode02:~# cd /etc/containerd/
root@kubenode02:/etc/containerd# ls
config.toml
root@kubenode02:/etc/containerd# rm ./config.toml 
root@kubenode02:/etc/containerd# cd 
root@kubenode02:~# systemctl restart containerd.service
root@kubenode02:~# systemctl status containerd.service
● containerd.service - containerd container runtime
   Loaded: loaded (/lib/systemd/system/containerd.service; enabled; vendor preset: enabled)
   Active: active (running) since Sat 2022-08-20 12:36:46 UTC; 23s ago
     Docs: https://containerd.io
  Process: 26784 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS)
 Main PID: 26789 (containerd)
    Tasks: 11
   CGroup: /system.slice/containerd.service
           └─26789 /usr/bin/containerd

Aug 20 12:36:46 kubenode02 containerd[26789]: time="2022-08-20T12:36:46.974356646Z" level=info msg="Get image filesystem path "/var/lib/containerd/io.contain
Aug 20 12:36:46 kubenode02 containerd[26789]: time="2022-08-20T12:36:46.974800648Z" level=error msg="Failed to load cni during init, please check CRI plugin 
Aug 20 12:36:46 kubenode02 containerd[26789]: time="2022-08-20T12:36:46.975350772Z" level=info msg="loading plugin "io.containerd.grpc.v1.introspection"..." 
Aug 20 12:36:46 kubenode02 containerd[26789]: time="2022-08-20T12:36:46.977433016Z" level=info msg=serving... address="/run/containerd/containerd.sock"
Aug 20 12:36:46 kubenode02 containerd[26789]: time="2022-08-20T12:36:46.977643428Z" level=info msg="containerd successfully booted in 0.027538s"
Aug 20 12:36:47 kubenode02 containerd[26789]: time="2022-08-20T12:36:47.028812797Z" level=info msg="Start subscribing containerd event"
Aug 20 12:36:47 kubenode02 containerd[26789]: time="2022-08-20T12:36:47.029129340Z" level=info msg="Start recovering state"
Aug 20 12:36:47 kubenode02 containerd[26789]: time="2022-08-20T12:36:47.029576587Z" level=info msg="Start event monitor"
Aug 20 12:36:47 kubenode02 containerd[26789]: time="2022-08-20T12:36:47.029779826Z" level=info msg="Start snapshots syncer"
Aug 20 12:36:47 kubenode02 containerd[26789]: time="2022-08-20T12:36:47.030033382Z" level=info msg="Start streaming server"
root@kubenode02:~# kubeadm join 192.168.56.2:6443 --token nn7d5f.63zmuuhpk7e1cq7x --discovery-token-ca-cert-hash sha256:7991672102244985b96f13713de43e85246fd165972d86d300f70a7120e116fc
[preflight] Running pre-flight checks
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Starting the kubelet
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.

root@kubenode02:~# 
```
- 状態確認　※マスターノードで実行※
```
kubectl get nodes
kubectl run nginx --image=nginx
kubectl get pods
kubectl delete pod nginx
```
```
vagrant@kubemaster:~$ kubectl get nodes
NAME         STATUS   ROLES           AGE     VERSION
kubemaster   Ready    control-plane   21m     v1.24.4
kubenode01   Ready    <none>          119s    v1.24.4
kubenode02   Ready    <none>          4m17s   v1.24.4
vagrant@kubemaster:~$ kubectl run nginx --image=nginx
pod/nginx created
vagrant@kubemaster:~$ kubectl get pods
NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          32s
vagrant@kubemaster:~$ kubectl delete pod nginx
pod "nginx" deleted
vagrant@kubemaster:~$ 
```